<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0" />
<title>Para mi Coneja üíû ‚Äî Corregido</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --accent:#ff6ea6;
  --accent-2:#ffd6e1;
  --soft:#fff6fb;
  --card-surface: rgba(255,255,255,0.96);
}

/* Base reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:"Poppins",sans-serif;
  color:#111;
  min-height:100vh;
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
  background:#fff;
}

/* Background layers for parallax & animated gradient */
.bg-wrap{ position:fixed; inset:0; z-index:-40; pointer-events:none; overflow:hidden; }
.bg-image{ position:absolute; inset:0; background-image: url("fondo.jpeg"); background-size:cover; background-position:center; transform: translateZ(0); will-change:transform; filter: saturate(.96) contrast(.98) brightness(.98); pointer-events:none; }
.bg-gradient{ position:absolute; inset:0; background: linear-gradient(120deg, rgba(255,150,190,0.08), rgba(255,230,245,0.06)); mix-blend-mode: screen; animation: gradientShift 14s linear infinite; opacity:.85; pointer-events:none; }
@keyframes gradientShift{ 0%{ transform:translateY(0) } 50%{ transform:translateY(6%) } 100%{ transform:translateY(0) } }

.bg-bloom{ position:absolute; left:-20%; top:-30%; width:140%; height:140%; background: radial-gradient(600px 400px at 20% 20%, rgba(255,200,230,0.18), transparent 18%), radial-gradient(500px 300px at 80% 80%, rgba(255,180,210,0.12), transparent 18%); filter: blur(28px) saturate(1.1); pointer-events:none; mix-blend-mode: screen; }
.bg-vignette{ position:absolute; inset:0; pointer-events:none; background: radial-gradient(60% 60% at 50% 40%, transparent 40%, rgba(0,0,0,0.06) 100%); mix-blend-mode:multiply; }

/* Canvas for particles/emojis */
#emojiCanvas{ position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:850; }

/* Darken overlay used when showing collage */
.darken-overlay{ position:fixed; inset:0; pointer-events:none; opacity:0; transition:opacity 560ms ease; z-index:700; }
.darken-overlay.active{ background: rgba(0,0,0,0.36); opacity:1; }

/* Intro screen */
.inicio{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:1000; padding:28px; background: linear-gradient(180deg, rgba(255,240,247,0.98) 0%, rgba(255,220,235,0.98) 100%); transition: opacity .6s, transform .6s; }
.inicio.hidden{ opacity:0; transform: translateY(-10px); pointer-events:none }
.inicio .card{ width:100%; max-width:720px; text-align:center; padding:28px; border-radius:18px; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,250,253,0.98)); box-shadow: 0 22px 48px rgba(160,30,90,0.08); border: 1px solid rgba(255,120,155,0.06); }
.inicio h1{ font-family:"Dancing Script", "Poppins"; color: #b91f5e; font-size: clamp(1.4rem, 4.5vw, 2.4rem); margin-bottom:12px; text-shadow: 0 8px 20px rgba(185,30,94,0.06); }
.inicio p{ color:#6b6b6b; margin-bottom:18px; font-weight:600; }

/* Buttons */
.botones{ position:relative; width:100%; max-width:420px; margin: 0 auto; height:66px; display:flex; align-items:center; justify-content:center; gap:18px; }
button.btn{ padding:12px 22px; border-radius:999px; border:none; font-weight:700; font-size:1rem; cursor:pointer; transition: transform .18s ease, box-shadow .18s ease; will-change: transform; }
button#si{ background: linear-gradient(180deg,#ff9ac4,#ff5c92); color:white; box-shadow: 0 12px 30px rgba(255,80,140,0.12); }
button#no{ background:white; color:#ff5c92; box-shadow: 0 6px 18px rgba(0,0,0,0.06); position:static; }

/* Audio control */
.audio-control{ position:fixed; right:16px; bottom:16px; z-index:1100; background: rgba(255,255,255,0.9); border-radius:999px; padding:8px; display:flex; gap:8px; align-items:center; box-shadow: 0 12px 36px rgba(0,0,0,0.08); }
.audio-control button{ background:transparent; border:none; font-size:1.05rem; cursor:pointer; padding:6px; border-radius:8px; }

/* Sticky countdown */
.countdown-bar{
  position: sticky; top:22px; z-index:900; width: min(980px,94%); margin: 18px auto; background: var(--card-surface); border-radius:14px; padding:12px 16px; display:flex; justify-content:space-between; gap:12px; align-items:center; box-shadow: 0 8px 28px rgba(0,0,0,0.06); border:1px solid rgba(255,110,140,0.06); backdrop-filter: blur(6px);
  transition: transform .28s ease, opacity .28s ease;
}
.countdown-bar.hidden{ transform: translateY(-120%); opacity:0; pointer-events:none; }

.countdown-left{ display:flex; gap:12px; align-items:center; }
.heart-deco{ font-size:22px; transform: translateY(-1px); filter: drop-shadow(0 6px 12px rgba(255,110,140,0.12)); }
.time-now{ font-family:"Dancing Script","Poppins"; font-size:1.28rem; color:#c92e66; font-weight:700; }
.time-detailed{ font-size:.9rem; color:#6b6b6b; margin-top:2px; }

/* Collage & polaroids */
.collage{ display:none; gap:22px; padding:12px 8px 48px; align-items:center; flex-direction:column; margin-top:8px; opacity:0; transition: opacity .7s ease; z-index:800; }
.collage.visible{ display:flex; opacity:1; }
.polaroid{ width:88%; max-width:560px; background:var(--card-surface); border-radius:12px; box-shadow: 0 18px 44px rgba(0,0,0,0.10); padding:10px; transform: translateY(8px) rotate(var(--r)); transition: transform .48s cubic-bezier(.2,.9,.3,1), box-shadow .28s; cursor:pointer; touch-action: pan-y; position:relative; overflow:visible; }
.polaroid.visible{ transform: translateY(0) rotate(var(--r)); }
.polaroid:focus{ outline: 3px solid rgba(255,117,157,0.12); }
.polaroid:hover{ transform: scale(1.04) rotate(0deg); box-shadow: 0 28px 64px rgba(0,0,0,0.12); }

/* tilt */
.tilt{ transform-style: preserve-3d; will-change: transform; }

/* Frame & video */
.frame{ background:#000; border-radius:10px; overflow:hidden; position:relative; }
video{ display:block; width:100%; height:auto; transform-origin:center center; transition: transform .28s ease, filter .28s ease; filter: brightness(.6) saturate(.96) contrast(.98); }

/* sticker pulse */
.sticker{ position:absolute; right:14px; top:14px; background: linear-gradient(90deg,#fff,#fff1f6); padding:6px 10px; border-radius:999px; font-weight:800; color:var(--accent); box-shadow: 0 10px 26px rgba(255,80,140,0.08); font-size:.9rem; transform-origin:center; }
.pulse{ animation: heartPulse 1500ms infinite cubic-bezier(.25,.85,.3,1); }
@keyframes heartPulse{ 0%{ transform: scale(1) } 45%{ transform: scale(1.06) } 100%{ transform: scale(1) } }

@keyframes popIn { from { transform: translateY(18px) scale(.98); opacity:0 } to { transform: translateY(0) scale(1); opacity:1 } }
.polaroid{ animation: popIn .6s ease both; }

/* responsive tweaks */
@media (max-width:480px){
  .polaroid{ width:94% }
  .countdown-bar{ width: calc(100% - 28px); top:8px; padding:10px; }
  .time-now{ font-size:1.05rem; }
  .sticker{ display:none; }
  .inicio .card{ padding:18px; }
}

/* prefers-reduced-motion */
@media (prefers-reduced-motion: reduce){
  *{ animation-duration:0.01ms !important; animation-iteration-count:1 !important; transition:none !important; scroll-behavior:auto !important; }
  #emojiCanvas{ display:none !important; }
  .bg-gradient{ animation:none; }
}
</style>
</head>
<body>

<!-- Background layers -->
<div class="bg-wrap" aria-hidden="true">
  <div class="bg-image" id="bgImage"></div>
  <div class="bg-gradient"></div>
  <div class="bg-bloom"></div>
  <div class="bg-vignette"></div>
</div>

<canvas id="emojiCanvas" aria-hidden="true"></canvas>
<div class="darken-overlay" id="darken"></div>

<!-- Intro -->
<div class="inicio" id="inicio" role="dialog" aria-label="Pantalla inicial">
  <div class="card">
    <h1>¬øEst√°s lista, coneja? üê∞üíû</h1>
    <p>He preparado algo especial ‚Äî presiona "S√≠" y deja que la sorpresa empiece.</p>
    <div class="botones" id="botones">
      <button id="si" class="btn" aria-label="S√≠, estoy lista">S√≠ üíñ</button>
      <button id="no" class="btn" aria-label="No, no quiero">No üíî</button>
    </div>
  </div>
</div>

<!-- Collage -->
<div class="collage" id="collage" aria-live="polite">
  <div class="countdown-bar" id="countdownBar" role="region" aria-label="Hora Per√∫ y tiempo hasta el d√≠a 3">
    <div class="countdown-left">
      <div class="heart-deco">üíó</div>
      <div>
        <div style="font-size:0.92rem;color:#666;">Hora Per√∫</div>
        <div class="time-now" id="peruNow">--:--:--</div>
        <div class="time-detailed" id="peruDetailed">--</div>
      </div>
    </div>
    <div class="countdown-right" style="text-align:right">
      <div style="font-size:0.9rem;color:#6b6b6b">¬øCu√°nto falta para el 03?</div>
      <div class="time-remaining" id="timeRemaining">-- d√≠as ‚Äî --:--:--</div>
    </div>
  </div>

  <div class="polaroid tilt" style="--r:-4deg;" tabindex="0">
    <div class="sticker pulse">Para ti</div>
    <div class="frame"><video muted loop playsinline preload="metadata" data-src="video1.mp4" aria-label="Video 1"></video></div>
  </div>

  <div class="polaroid tilt" style="--r:3deg;" tabindex="0">
    <div class="sticker">Recuerdos</div>
    <div class="frame"><video muted loop playsinline preload="metadata" data-src="video2.mp4" aria-label="Video 2"></video></div>
  </div>

  <div class="polaroid tilt" style="--r:-2deg;" tabindex="0">
    <div class="sticker">Te amo</div>
    <div class="frame"><video muted loop playsinline preload="metadata" data-src="video3.mp4" aria-label="Video 3"></video></div>
  </div>

  <div class="polaroid tilt" style="--r:4deg;" tabindex="0">
    <div class="sticker">Siempre</div>
    <div class="frame"><video muted loop playsinline preload="metadata" data-src="video4.mp4" aria-label="Video 4"></video></div>
  </div>

  <div class="polaroid tilt" style="--r:-5deg;" tabindex="0">
    <div class="sticker">Besitos</div>
    <div class="frame"><video muted loop playsinline preload="metadata" data-src="video5.mp4" aria-label="Video 5"></video></div>
  </div>
</div>

<!-- Audio controls -->
<audio id="bg-audio" src="no_hay_nadie_mas.mp3" loop preload="none"></audio>
<div class="audio-control" id="audioControl" aria-hidden="false">
  <button id="audioToggle" aria-label="Reproducir m√∫sica">‚ñ∂Ô∏è</button>
  <label style="font-size:.9rem;color:#333;user-select:none">M√∫sica</label>
  <button id="emojiToggle" aria-label="Toggle decoraciones">‚ú®</button>
</div>

<script>
/* ======= C√≥digo principal corregido y robusto =======
   - Listeners para click/pointer/touch en S√≠/No (compatibilidad)
   - Asegura pointer-events:none en capas de fondo/canvas
   - Fallback visual en caso de bloqueo de otro script
   - Mantiene canvas particles y lazy-load para videos
   ================================================== */

document.addEventListener('DOMContentLoaded', () => {
  const inicio = document.getElementById('inicio');
  const collage = document.getElementById('collage');
  const btnSi = document.getElementById('si');
  const btnNo = document.getElementById('no');
  const botones = document.getElementById('botones');
  const darken = document.getElementById('darken');
  const audio = document.getElementById('bg-audio');
  const audioToggle = document.getElementById('audioToggle');
  const emojiToggle = document.getElementById('emojiToggle');
  const canvas = document.getElementById('emojiCanvas');
  const ctx = canvas.getContext && canvas.getContext('2d');
  const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  /* --- Asegurar que capas no intercepten punteros --- */
  ['emojiCanvas','bgImage','bg-gradient','bg-bloom','bg-vignette'].forEach(sel => {
    const elById = document.getElementById(sel);
    if (elById) elById.style.pointerEvents = 'none';
    const elByClass = document.querySelector('.' + sel);
    if (elByClass) elByClass.style.pointerEvents = 'none';
  });

  /* --- Simple canvas resize helper --- */
  function resizeCanvas(){
    if (!ctx) return;
    const DPR = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.floor(window.innerWidth * DPR);
    canvas.height = Math.floor(window.innerHeight * DPR);
    canvas.style.width = window.innerWidth + 'px';
    canvas.style.height = window.innerHeight + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  resizeCanvas();
  window.addEventListener('resize', debounce(resizeCanvas, 120), {passive:true});

  /* --- Particle system ligero (canvas) --- */
  const EMOJIS = ['üíñ','üå∏','üíû','üåπ','üíï','‚ú®'];
  const particles = [];
  const MAX_PARTICLES = 48;
  let lastTs = performance.now();
  let runningCanvas = false;

  class P {
    constructor(opts){
      this.x = opts.x; this.y = opts.y;
      this.vx = opts.vx; this.vy = opts.vy;
      this.size = opts.size; this.ttl = opts.ttl; this.age = 0;
      this.type = opts.type; this.ch = opts.ch; this.rot = opts.rot || 0; this.rov = opts.rov || 0;
    }
    step(dt){
      this.age += dt;
      this.x += this.vx * dt;
      this.y += this.vy * dt;
      this.rot += this.rov * dt;
      return this.age < this.ttl;
    }
    draw(ctx){
      const o = Math.max(0, 1 - this.age / this.ttl);
      ctx.save();
      ctx.globalAlpha = o;
      ctx.translate(this.x, this.y);
      ctx.rotate(this.rot);
      if (this.type === 'emoji') {
        ctx.font = `${this.size}px "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji", sans-serif`;
        ctx.textAlign = 'center'; ctx.textBaseline='middle';
        ctx.fillText(this.ch, 0, 0);
      } else {
        const g = ctx.createRadialGradient(0,0,this.size*0.1,0,0,this.size);
        g.addColorStop(0, `rgba(255,255,255,${0.9*o})`);
        g.addColorStop(0.3, `rgba(255,200,230,${0.6*o})`);
        g.addColorStop(1, `rgba(255,120,160,${0.0})`);
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(0,0, this.size, 0, Math.PI*2); ctx.fill();
      }
      ctx.restore();
    }
  }

  function spawnEmojiBurst(count=6, area=null){
    for (let i=0;i<count;i++){
      if (particles.length >= MAX_PARTICLES) break;
      const x = area ? (area.x + Math.random()*area.w) : (window.innerWidth * (0.2 + Math.random()*0.6));
      const y = area ? (area.y + Math.random()*area.h) : (window.innerHeight + 20);
      particles.push(new P({
        x, y,
        vx: -10 + Math.random()*40,
        vy: -60 - Math.random()*80,
        size: 18 + Math.random()*28,
        ttl: 5 + Math.random()*4,
        type: 'emoji',
        ch: EMOJIS[Math.floor(Math.random()*EMOJIS.length)],
        rot: (Math.random()-0.5)*0.6,
        rov: (Math.random()-0.5)*0.7
      }));
    }
  }

  function spawnSparkle(x, y, count=1){
    for (let i=0;i<count;i++){
      if (particles.length >= MAX_PARTICLES) return;
      const angle = -Math.PI/2 + (Math.random()-0.5)*1.6;
      const speed = 30 + Math.random()*80;
      particles.push(new P({
        x, y,
        vx: Math.cos(angle)*speed*(0.4+Math.random()),
        vy: Math.sin(angle)*speed*(0.6+Math.random()),
        size: 6 + Math.random()*10, ttl: 0.9 + Math.random()*0.8,
        type: 'spark'
      }));
    }
  }

  function loopCanvas(ts){
    if (!ctx) return;
    const dt = Math.min(0.06, (ts - lastTs)/1000);
    lastTs = ts;
    ctx.clearRect(0,0,window.innerWidth, window.innerHeight);
    if (!reduced && Math.random() < 0.02) spawnSparkle(Math.random()*window.innerWidth, window.innerHeight - 20 - Math.random()*30, 1);
    for (let i = particles.length -1; i>=0; i--){
      const p = particles[i];
      if (!p.step(dt)) particles.splice(i,1);
      else p.draw(ctx);
    }
    if (runningCanvas) requestAnimationFrame(loopCanvas);
  }
  function startCanvas(){ if (runningCanvas || reduced || !ctx) return; runningCanvas = true; lastTs = performance.now(); requestAnimationFrame(loopCanvas); }
  function stopCanvas(){ runningCanvas = false; }

  /* --- moveNo (evitar que 'No' no exista) --- */
  function moveNo(){
    const cont = botones.getBoundingClientRect();
    const noRect = btnNo.getBoundingClientRect();
    const padding = 8;
    const maxX = Math.max(0, cont.width - noRect.width - padding);
    const maxY = Math.max(0, cont.height - noRect.height - padding);
    const x = Math.random() * maxX;
    const y = Math.random() * maxY;
    btnNo.style.position = 'absolute';
    btnNo.style.left = `${x}px`;
    btnNo.style.top = `${y}px`;
  }

  /* --- fallback: abrir collage si alg√∫n listener no funciona --- */
  function openCollageFallback(){
    if (inicio && !inicio.classList.contains('hidden')) inicio.classList.add('hidden');
    if (darken && !darken.classList.contains('active')) darken.classList.add('active');
    if (collage && getComputedStyle(collage).display === 'none') {
      collage.style.display = 'flex';
      setTimeout(()=> collage.classList.add('visible'), 20);
    } else if (collage && !collage.classList.contains('visible')) {
      collage.classList.add('visible');
    }
    // intentar audio (no await)
    if (audio) {
      audio.play().then(()=> { if (audioToggle) audioToggle.textContent = '‚è∏Ô∏è'; }).catch(()=> { if (audioToggle) audioToggle.textContent = '‚ñ∂Ô∏è'; });
    }
    // start visuals
    startCanvas();
    spawnEmojiBurst(12);
    spawnSparkle(window.innerWidth*0.5, window.innerHeight*0.65, 8);
    startPeruCountdown();
  }

  /* --- Handlers para S√≠ / No (multi-event) --- */
  function onYes(e){
    if (e && e.preventDefault) e.preventDefault();
    // seguridad: evitar que un overlay impida la acci√≥n
    openCollageFallback();
  }

  function onNo(e){
    if (e && e.preventDefault) e.preventDefault();
    // movimiento evasivo
    moveNo();
    try { btnNo.animate([{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:360,iterations:1}); } catch(e){}
  }

  function addMultiListener(el, handler){
    if (!el) return;
    if (el._attached) return;
    el._attached = true;
    el.addEventListener('click', handler, {passive:false});
    el.addEventListener('pointerdown', handler, {passive:false});
    el.addEventListener('touchstart', handler, {passive:false});
  }

  addMultiListener(btnSi, onYes);
  addMultiListener(btnNo, onNo);

  /* If buttons are present but not responding on some devices, also attach via document (fallback) */
  // slight safeguard: if DOM exists but user doesn't interact, attach document-level pointer handler to catch first tap
  let fallbackAttached = false;
  function attachDocumentFallback(){
    if (fallbackAttached) return;
    fallbackAttached = true;
    document.addEventListener('pointerdown', function docHandler(ev){
      const t = ev.target;
      // if user tapped the visible "si" or "no" elements visually, trigger their handlers
      if (t && (t.closest && t.closest('#si'))) { onYes(ev); }
      if (t && (t.closest && t.closest('#no'))) { onNo(ev); }
      // remove fallback after first use
      document.removeEventListener('pointerdown', docHandler);
    }, {passive:true});
  }
  attachDocumentFallback();

  /* --- Audio toggle simple --- */
  if (audioToggle) {
    audioToggle.addEventListener('click', () => {
      if (audio.paused) {
        audio.play().then(()=> audioToggle.textContent = '‚è∏Ô∏è').catch(()=> audioToggle.textContent = '‚ñ∂Ô∏è');
      } else {
        audio.pause(); audioToggle.textContent = '‚ñ∂Ô∏è';
      }
    }, {passive:true});
  }

  /* emoji toggle */
  let emojisEnabled = true;
  if (emojiToggle) {
    emojiToggle.addEventListener('click', () => {
      emojisEnabled = !emojisEnabled;
      emojiToggle.classList.toggle('active', emojisEnabled);
      if (!emojisEnabled) stopCanvas();
      else startCanvas();
    }, {passive:true});
  }

  /* --- IntersectionObserver for videos: lazy load + pause when offscreen --- */
  const videos = Array.from(document.querySelectorAll('video'));
  const io = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      const v = e.target;
      if (e.isIntersecting) {
        if (!v.src){
          const src = v.getAttribute('data-src');
          if (src) v.src = src;
        }
      } else {
        try { v.pause(); } catch(e){}
      }
    });
  }, { root: null, rootMargin: '120px 0px', threshold: 0.25 });
  videos.forEach(v => io.observe(v));

  /* --- Tilt + touch long-press preserved --- */
  const LONG_PRESS_MS = 260;
  const MOVE_TOLERANCE_PX = 10;
  document.querySelectorAll('.polaroid').forEach(p => {
    let touchTimer = null;
    let startX = 0, startY = 0, moved = false;
    const v = p.querySelector('video');
    function activate(){ p.classList.add('hovering'); if (v) v.play().catch(()=>{}); }
    function deactivate(){ p.classList.remove('hovering'); if (v) v.pause(); }
    p.addEventListener('touchstart', (ev) => {
      if (ev.touches && ev.touches[0]) { startX = ev.touches[0].clientX; startY = ev.touches[0].clientY; }
      moved = false;
      touchTimer = setTimeout(()=> { if (!moved) activate(); }, LONG_PRESS_MS);
    }, {passive:true});
    p.addEventListener('touchmove', (ev) => {
      if (ev.touches && ev.touches[0]) {
        const dx = Math.abs(ev.touches[0].clientX - startX);
        const dy = Math.abs(ev.touches[0].clientY - startY);
        if (dx > MOVE_TOLERANCE_PX || dy > MOVE_TOLERANCE_PX) {
          moved = true;
          if (touchTimer) { clearTimeout(touchTimer); touchTimer = null; }
          if (p._pressActive) deactivate();
        }
      }
    }, {passive:true});
    p.addEventListener('touchend', () => {
      if (touchTimer) { clearTimeout(touchTimer); touchTimer = null; }
      if (p._pressActive) { setTimeout(()=> deactivate(), 40); }
    }, {passive:true});
    p.addEventListener('touchcancel', () => { if (touchTimer) { clearTimeout(touchTimer); touchTimer = null; } deactivate(); }, {passive:true});
    p.addEventListener('mouseenter', ()=> { p.classList.add('hovering'); if (v) v.play().catch(()=>{}); }, {passive:true});
    p.addEventListener('mouseleave', ()=> { p.classList.remove('hovering'); if (v) v.pause(); }, {passive:true});
    p.addEventListener('focus', ()=> { p.classList.add('hovering'); if (v) v.play().catch(()=>{}); }, {passive:true});
    p.addEventListener('blur', ()=> { p.classList.remove('hovering'); if (v) v.pause(); }, {passive:true});
  });

  /* --- Countdown (Hora Per√∫) --- */
  function formatPeruNowParts(){
    const now = new Date();
    const timeStr = new Intl.DateTimeFormat('es-PE', { timeZone: 'America/Lima', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false }).format(now);
    const dateStr = new Intl.DateTimeFormat('es-PE', { timeZone: 'America/Lima', weekday:'long', day:'numeric', month:'long', year:'numeric' }).format(now);
    return { timeStr, dateStr, zoneStr: 'GMT-5' };
  }
  function msUntilNextThirdPeru(){
    const nowUTCms = Date.now();
    const parts = new Intl.DateTimeFormat('en-US', { timeZone: 'America/Lima', year:'numeric', month:'numeric', day:'numeric', hour:'numeric', minute:'numeric', second:'numeric' }).formatToParts(new Date());
    const map = {};
    parts.forEach(p => map[p.type] = p.value);
    let y = parseInt(map.year,10), m = parseInt(map.month,10), d = parseInt(map.day,10);
    let h = parseInt(map.hour || 0,10), min = parseInt(map.minute || 0,10), s = parseInt(map.second || 0,10);
    let ty = y, tm = m;
    if (d > 3 || (d === 3 && (h > 0 || min > 0 || s > 0))) { tm++; if (tm>12){ tm=1; ty++; } }
    const targetUTCms = Date.UTC(ty, tm-1, 3, 5, 0, 0);
    return Math.max(0, targetUTCms - nowUTCms);
  }
  function formatRemaining(ms){
    const totalSec = Math.floor(ms/1000);
    const days = Math.floor(totalSec/86400);
    let rem = totalSec % 86400;
    const hours = Math.floor(rem/3600);
    rem = rem%3600;
    const minutes = Math.floor(rem/60);
    const seconds = rem%60;
    return `${days} d√≠as ‚Äî ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
  }
  let countdownInterval = null;
  function updatePeruCountdown(){
    const p = formatPeruNowParts();
    const peruNowEl = document.getElementById('peruNow');
    const peruDetailedEl = document.getElementById('peruDetailed');
    const timeRemainingEl = document.getElementById('timeRemaining');
    if (peruNowEl) peruNowEl.textContent = p.timeStr;
    if (peruDetailedEl) peruDetailedEl.textContent = `${p.dateStr} (${p.zoneStr})`;
    if (timeRemainingEl) timeRemainingEl.textContent = formatRemaining(msUntilNextThirdPeru());
  }
  function startPeruCountdown(){ if (countdownInterval) return; updatePeruCountdown(); countdownInterval = setInterval(updatePeruCountdown, 1000); }
  function stopPeruCountdown(){ clearInterval(countdownInterval); countdownInterval = null; }

  /* --- visibility handling --- */
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) { stopCanvas(); stopPeruCountdown(); }
    else { startCanvas(); if (collage.classList.contains('visible')) startPeruCountdown(); }
  });

  /* --- small activity-based canvas control --- */
  let noActivityTimer = null;
  function resetNoActivityTimer(){
    if (noActivityTimer) clearTimeout(noActivityTimer);
    noActivityTimer = setTimeout(()=> { if (!collage.classList.contains('visible')) stopCanvas(); }, 5000);
  }
  ['mousemove','touchstart','scroll'].forEach(ev => window.addEventListener(ev, ()=> { startCanvas(); resetNoActivityTimer(); }, {passive:true}));

  /* --- initial preview spawns --- */
  window.requestAnimationFrame(()=> {
    spawnSparkle(window.innerWidth*0.45, window.innerHeight*0.55, 6);
    if (!reduced) spawnEmojiBurst(4);
  });

  /* --- Dev / fallback attach: if the original listeners from another script were removed, these still work --- */
  // Nothing more to do: handlers added earlier via addMultiListener

  /* --- Debounce util --- */
  function debounce(fn, ms=80){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  /* --- Confetti spawn (light) on click when collage visible --- */
  document.addEventListener('click', (ev) => {
    if (collage.classList.contains('visible') && !reduced){
      const cx = ev.clientX, cy = ev.clientY;
      spawnSparkle(cx, cy, 6);
      spawnEmojiBurst(2, {x: cx-40, y: cy-20, w:80, h:40});
    }
  }, {passive:true});

  /* --- Safety: ensure polaroid videos paused on load --- */
  window.addEventListener('load', () => {
    document.querySelectorAll('video').forEach(v => { try { v.pause(); v.muted = true; v.playsInline = true; } catch(e){} });
  });

  // Expose minimal helpers for debugging in console if needed
  window._pm = {
    openCollageFallback,
    spawnEmojiBurst,
    spawnSparkle,
    startCanvas,
    stopCanvas,
    moveNo
  };
});
</script>
</body>
</html>
